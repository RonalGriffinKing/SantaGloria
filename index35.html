<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Etiquetas</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="productos.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background-color: #f9f9f9;
  }
  .producto-card {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 180px;
    height: 180px;
    margin: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    background-color: #fff;
  }
  .productos-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .floating-buttons {
    position: fixed;
    right: 20px;
    bottom: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 100;
  }
  .floating-buttons button {
    width: 150px;
  }
  table {
    margin-top: 20px;
    width: 100%;
    border-collapse: collapse;
  }
  table, th, td {
    border: 1px solid #aaa;
  }
  th, td {
    padding: 5px 10px;
    text-align: center;
  }
  select, input {
    width: 100%;
    margin-top: 5px;
  }
</style>
</head>
<body>

<h1>Generador de Etiquetas</h1>

<div class="productos-container" id="productosContainer">
  <!-- Productos se cargarán aquí dinámicamente -->
</div>

<table id="etiquetasTable">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Tipo</th>
      <th>Estado</th>
      <th>Lote</th>
      <th>Caducidad</th>
      <th>Fecha apertura</th>
      <th>Hora apertura</th>
      <th>Fecha cierre</th>
      <th>Hora cierre</th>
      <th>Círculo</th>
    </tr>
  </thead>
  <tbody>
    <!-- Filas generadas -->
  </tbody>
</table>

<div class="floating-buttons">
  <button class="btn btn-primary" id="generarBtn">Generar</button>
  <button class="btn btn-success" id="descargarBtn">Descargar XLSX</button>
  <button class="btn btn-secondary" id="actualizarBtn">Actualizar</button>
  <button class="btn btn-warning" id="siguienteBtn">Siguiente Etiqueta</button>
  <button class="btn btn-info" id="obradorBtn">Ir a Obrador</button>
  <button class="btn btn-dark" id="consultarBtn">Consultar</button>
</div>

<script>
const productosContainer = document.getElementById('productosContainer');
const etiquetasTable = document.getElementById('etiquetasTable').getElementsByTagName('tbody')[0];

function cargarProductos() {
  productosContainer.innerHTML = '';
  for (let categoria in productosData) {
    productosData[categoria].forEach(producto => {
      const card = document.createElement('div');
      card.className = 'producto-card';
      card.innerHTML = `
        <strong>${producto.nombre}</strong>
        <select class="estadoSelect">
          <option value="Fresco">Fresco</option>
          <option value="Refrigerado y abierto">Refrigerado y abierto</option>
          <option value="Descongelado sin abrir">Descongelado sin abrir</option>
          <option value="Cocinado y refrigerado">Cocinado y refrigerado</option>
          <option value="Sin abrir">Sin abrir</option>
          <option value="Abierto">Abierto</option>
        </select>
        <div>Lote: ${producto.lote}</div>
      `;
      productosContainer.appendChild(card);
    });
  }
}

function generarEtiquetas() {
  etiquetasTable.innerHTML = '';
  const now = new Date();
  const fechaActual = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
  const horaActual = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

  document.querySelectorAll('.producto-card').forEach(card => {
    const nombre = card.querySelector('strong').innerText;
    const estado = card.querySelector('select').value;
    const lote = card.querySelector('div').innerText.replace('Lote: ','');
    // Buscar producto en JS por nombre y estado
    let productoData;
    for (let categoria in productosData) {
      productoData = productosData[categoria].find(p => p.nombre === nombre && (p.estado === estado || p.estado.includes(estado)));
      if (productoData) break;
    }
    if (!productoData) return;

    // Calcular caducidad
    const caducidad = productoData.caducidad_primaria || calcularCaducidad(productoData.dias);

    // Círculo
    const circulo = '○';

    const row = etiquetasTable.insertRow();
    row.insertCell().innerText = nombre;
    row.insertCell().innerText = productoData.tipo;
    row.insertCell().innerText = estado;
    row.insertCell().innerText = lote;
    row.insertCell().innerText = caducidad;
    row.insertCell().innerText = fechaActual;
    row.insertCell().innerText = horaActual;
    row.insertCell().innerText = fechaActual;
    row.insertCell().innerText = horaActual;
    row.insertCell().innerText = circulo;
  });
}

function calcularCaducidad(dias) {
  const fecha = new Date();
  fecha.setDate(fecha.getDate() + dias);
  return `${String(fecha.getDate()).padStart(2,'0')}/${String(fecha.getMonth()+1).padStart(2,'0')}/${fecha.getFullYear()}`;
}

function descargarXLSX() {
  const wb = XLSX.utils.book_new();
  const ws_data = [];
  const headers = Array.from(etiquetasTable.rows[0].cells).map(cell => cell.innerText);
  ws_data.push(headers);

  Array.from(etiquetasTable.rows).forEach((row, i) => {
    if (i === 0) return;
    const rowData = Array.from(row.cells).map(cell => cell.innerText);
    ws_data.push(rowData);
  });

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, 'Etiquetas');
  XLSX.writeFile(wb, 'etiquetas.xlsx');
}

// Botones flotantes
document.getElementById('generarBtn').addEventListener('click', generarEtiquetas);
document.getElementById('descargarBtn').addEventListener('click', descargarXLSX);
document.getElementById('actualizarBtn').addEventListener('click', cargarProductos);
document.getElementById('siguienteBtn').addEventListener('click', () => alert('Siguiente etiqueta'));
document.getElementById('obradorBtn').addEventListener('click', () => alert('Ir a Obrador'));
document.getElementById('consultarBtn').addEventListener('click', () => alert('Consultar'));

cargarProductos();
</script>

</body>
</html>
