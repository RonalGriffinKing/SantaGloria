<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Etiquetas de Productos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .categoria {
      margin-bottom: 20px;
    }

    .etiqueta {
      border: 1px solid #000;
      width: 5cm;
      height: 3cm;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
      font-size: 12px;
      text-align: center;
    }

    .resultado {
      border: 1px solid #000;
      padding: 10px;
      margin: 10px 0;
    }

    button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }

    input[type="checkbox"] {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h1>Gestor de Etiquetas</h1>

  <div id="categorias"></div>

  <button onclick="seleccionarTodo()">Seleccionar Todo</button>
  <button onclick="imprimirSeleccion()">Imprimir Seleccionados</button>

  <h2>Consulta de Productos</h2>
  <input type="text" id="buscador" placeholder="Buscar producto..." oninput="consultarProducto()">
  <div id="resultados"></div>

  <script src="productos.js"></script>
  <script>
    const contenedorCategorias = document.getElementById('categorias');

    // Render de productos
    for (let categoria in productos) {
      const div = document.createElement('div');
      div.classList.add('categoria');
      div.innerHTML = `<h3>${categoria}</h3>`;
      productos[categoria].forEach(prod => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = JSON.stringify({ ...prod, categoria });
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(prod.nombre));
        div.appendChild(label);
        div.appendChild(document.createElement('br'));
      });
      contenedorCategorias.appendChild(div);
    }

    function seleccionarTodo() {
      document.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.checked = true);
    }

    function imprimirSeleccion() {
      const seleccionados = [...document.querySelectorAll('input[type="checkbox"]:checked')];
      if (seleccionados.length === 0) {
        alert("No has seleccionado ningún producto.");
        return;
      }

      seleccionados.forEach(chk => {
        const prod = JSON.parse(chk.value);
        generarEtiqueta(prod);
      });
    }

    function generarEtiqueta(prod) {
      const apertura = new Date();
      const caducidad = new Date(apertura);
      if (prod.dias > 0) caducidad.setDate(apertura.getDate() + prod.dias);

      const aperturaFecha = apertura.toLocaleDateString('es-ES');
      const caducidadFecha = prod.dias === 0 ? "No aplica" : caducidad.toLocaleDateString('es-ES');

      const etiquetaHTML = `
        <div class="etiqueta">
          <strong>${prod.nombre}</strong><br>
          ${prod.categoria}<br>
          Duración: <strong>${prod.dias === 0 ? "No caduca" : prod.dias + (prod.dias === 1 ? " día" : " días")}</strong><br>
          Apertura: ${aperturaFecha}<br>
          Caducidad: ${caducidadFecha}
        </div>
      `;

      imprimirEtiqueta(etiquetaHTML);
    }

    function imprimirEtiqueta(etiquetaHTML) {
      const ventana = window.open('', '', 'width=400,height=400');
      ventana.document.write(`
        <html>
          <head>
            <title>Etiqueta</title>
            <style>
              @media print {
                @page { size: 5cm 3cm; margin: 0; }
                body { margin: 0; display: flex; justify-content: center; align-items: center; }
                .etiqueta { width: 5cm; height: 3cm; font-size: 12px; text-align: center; border: 1px solid black; }
              }
            </style>
          </head>
          <body>
            ${etiquetaHTML}
          </body>
        </html>
      `);
      ventana.document.close();
      ventana.onload = function() {
        ventana.print();
        ventana.onafterprint = function() { ventana.close(); }
      };
    }

    function consultarProducto() {
      const texto = document.getElementById('buscador').value.toLowerCase();
      const resultados = document.getElementById('resultados');
      resultados.innerHTML = "";

      for (let categoria in productos) {
        productos[categoria].forEach(prod => {
          if (prod.nombre.toLowerCase().includes(texto)) {
            const apertura = new Date();
            const caducidad = new Date(apertura);
            if (prod.dias > 0) caducidad.setDate(apertura.getDate() + prod.dias);

            const aperturaFecha = apertura.toLocaleDateString('es-ES');
            const caducidadFecha = prod.dias === 0 ? "No aplica" : caducidad.toLocaleDateString('es-ES');

            const div = document.createElement('div');
            div.classList.add('resultado');
            div.innerHTML = `
              <p><strong>Producto:</strong> ${prod.nombre}</p>
              <p><strong>Categoría:</strong> ${categoria}</p>
              <p><strong>Duración:</strong> <strong>${prod.dias === 0 ? "No caduca" : prod.dias + (prod.dias === 1 ? " día" : " días")}</strong></p>
              <p><strong>Apertura:</strong> ${aperturaFecha}</p>
              <p><strong>Caducidad:</strong> ${caducidadFecha}</p>
            `;
            resultados.appendChild(div);
          }
        });
      }
    }
  </script>
</body>
</html>
