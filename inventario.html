<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario – Santa Gloria Russafa</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#fff; color:#000; padding-bottom:100px; }
header { background: rgba(255,255,255,0.9); color:#000; text-align:center; padding:12px; font-size:1.2em; font-weight:bold; position:sticky; top:0; z-index:999; }
.nav-buttons { margin-top:8px; display:flex; flex-wrap:wrap; justify-content:center; gap:6px; }
.nav-buttons button { padding:6px 12px; border:none; border-radius:6px; background:#fff; color:#000; cursor:pointer; font-size:0.9em; border:1px solid #000; }
.nav-buttons button.active { background:#000; color:#fff; }
.nav-buttons button:hover { background:#eee; }
#buscador { width:90%; margin:10px auto; display:block; padding:8px 12px; border-radius:6px; border:2px solid #000; font-size:1em; }
#grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap:12px; padding:15px; }

.obrador-item { 
  border-radius:8px; 
  padding:12px; 
  background:#fff; 
  position:relative; 
  display:flex; 
  flex-direction:column; 
  justify-content:space-between; 
  overflow:hidden;
  border:1px solid #000;
}
.obrador-item h3 { margin:0 0 6px 0; font-size:1.1em; }
.obrador-item p { margin:2px 0; font-size:0.9em; }
.obrador-item .dias-restantes { 
  position:absolute; 
  top:8px; 
  right:8px; 
  font-weight:bold; 
  font-size:1.2em;
  background:#000; 
  color:#fff; 
  padding:4px 10px; 
  border-radius:6px;
}
.obrador-item::before { 
  content:''; 
  position:absolute; 
  left:0; 
  top:0; 
  width:10px; 
  height:100%; 
  background:var(--colorBorde, #ccc); 
  border-radius:0 8px 8px 0;
}
.obrador-item button { 
  background:#000; 
  color:#fff; 
  border:none; 
  padding:6px 10px; 
  border-radius:4px; 
  cursor:pointer; 
  font-size:0.85em; 
  margin-top:8px; 
}
.obrador-item button:hover { background:#333; }

/* Modal */
#modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:1000; }
.modal-content { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:420px; box-shadow:0 3px 6px rgba(0,0,0,0.2); display:flex; flex-direction:column; gap:10px; }
.modal-content h2 { margin:0; text-align:center; }
.modal-content label { font-weight:bold; font-size:0.9em; }
.modal-content input { padding:8px; border:1px solid #000; border-radius:6px; width:100%; }
.modal-content button { background:#000; color:#fff; border:none; padding:10px; border-radius:6px; cursor:pointer; margin-top:10px; }
.modal-content button:hover { background:#333; }
</style>
</head>
<body>

<header>
  Inventario – Santa Gloria Russafa
  <div class="nav-buttons">
    <button onclick="filtrarCategoria('')" class="active">Todos</button>
    <button onclick="filtrarCategoria('Quesos')">Quesos</button>
    <button onclick="filtrarCategoria('Dulces')">Dulces</button>
    <button onclick="filtrarCategoria('Embutidos')">Embutidos</button>
    <button onclick="filtrarCategoria('Ensaladas')">Ensaladas</button>
    <button onclick="filtrarCategoria('Frutas y Verduras')">Frutas y Verduras</button>
    <button onclick="filtrarCategoria('Pan')">Pan</button>
    <button onclick="filtrarCategoria('Cremas y Salsas')">Cremas y Salsas</button>
    <button onclick="filtrarCategoria('Tartas')">Tartas</button>
    <button onclick="filtrarCategoria('Otros')">Otros</button>
    <button onclick="descargarJSON()">⬇️ Descargar JSON</button>
  </div>
  <input type="text" id="buscador" placeholder="Buscar producto..." oninput="filtrarBusqueda()">
</header>

<main id="grid"></main>

<!-- Modal actualización -->
<div id="modal">
  <div class="modal-content">
    <h2 id="modalNombre"></h2>
    <label>Cantidad total</label>
    <input type="number" id="modalCantidadTotal">
    <label>Peso total</label>
    <input type="number" id="modalPesoTotal">
    <label>Cantidad disponible</label>
    <input type="number" id="modalCantidadDisponible">
    <label>Peso disponible</label>
    <input type="number" id="modalPesoDisponible">
    <label>Uso diario (cantidad)</label>
    <input type="number" id="modalUsoCantidad">
    <label>Uso diario (peso)</label>
    <input type="number" id="modalUsoPeso">
    <button onclick="guardarCambios()">Guardar</button>
  </div>
</div>

<script src="inventario.js"></script>
<script>
let productos = {};

// Copiar inventario inicial a localStorage si no existe
if (!localStorage.getItem('inventario')) {
  localStorage.setItem('inventario', JSON.stringify(productosIniciales)); // productosIniciales viene de inventario.js
}
productos = JSON.parse(localStorage.getItem('inventario'));

function calcularDias(p) {
  let dias = null;
  if (p.peso_disponible && p.uso_diario_peso) dias = p.peso_disponible / p.uso_diario_peso;
  else if (p.cantidad_disponible && p.uso_diario_cantidad) dias = p.cantidad_disponible / p.uso_diario_cantidad;
  return dias ? Math.floor(dias) : null;
}

function getColor(dias) {
  if (dias === null) return "#ccc";
  if (dias <= 1) return "red";
  if (dias === 2 || dias === 3) return "orange";
  return "green";
}

function renderGrid(categoria = "", search = "") {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  
  let items = [];
  for (let categoriaKey in productos) {
    productos[categoriaKey].forEach(p => {
      if ((categoria === "" || p.categoria === categoria) &&
          (search === "" || p.nombre.toLowerCase().includes(search.toLowerCase()))) {
        items.push(p);
      }
    });
  }

  // Ordenar por prioridad (rojo -> naranja -> verde)
  items.sort((a,b) => {
    const da = calcularDias(a);
    const db = calcularDias(b);
    const pa = da === null ? 3 : da <= 1 ? 0 : da <= 3 ? 1 : 2;
    const pb = db === null ? 3 : db <= 1 ? 0 : db <= 3 ? 1 : 2;
    return pa - pb;
  });

  items.forEach(p => {
    const dias = calcularDias(p);
    const color = getColor(dias);
    const card = document.createElement("div");
    card.className = "obrador-item";
    card.style.setProperty("--colorBorde", color);
    card.innerHTML = `
      <h3>${p.nombre}</h3>
      <span class="dias-restantes">${dias !== null ? dias + "d" : "?"}</span>
      <p><b>Cant. diaria:</b> ${p.uso_diario_cantidad ?? "-"} | <b>Peso diario:</b> ${p.uso_diario_peso ?? "-"}</p>
      <button onclick="abrirModal('${p.nombre}', '${p.categoria}')">Actualizar</button>
    `;
    grid.appendChild(card);
  });
}

function filtrarCategoria(cat) {
  document.querySelectorAll(".nav-buttons button").forEach(btn => btn.classList.remove("active"));
  event.target.classList.add("active");
  renderGrid(cat, document.getElementById("buscador").value);
}

function filtrarBusqueda() {
  renderGrid(document.querySelector(".nav-buttons button.active").textContent || "", document.getElementById("buscador").value);
}

let productoEditando = null;
function abrirModal(nombre, categoria) {
  productoEditando = { nombre, categoria };
  const p = productos[categoria].find(x => x.nombre === nombre);
  document.getElementById("modalNombre").textContent = nombre;
  document.getElementById("modalCantidadTotal").value = p.cantidad_caja ?? "";
  document.getElementById("modalPesoTotal").value = p.peso_caja ?? "";
  document.getElementById("modalCantidadDisponible").value = p.cantidad_disponible ?? "";
  document.getElementById("modalPesoDisponible").value = p.peso_disponible ?? "";
  document.getElementById("modalUsoCantidad").value = p.uso_diario_cantidad ?? "";
  document.getElementById("modalUsoPeso").value = p.uso_diario_peso ?? "";
  document.getElementById("modal").style.display = "flex";
}

function guardarCambios() {
  const { nombre, categoria } = productoEditando;
  let p = productos[categoria].find(x => x.nombre === nombre);
  p.cantidad_caja = Number(document.getElementById("modalCantidadTotal").value) || null;
  p.peso_caja = Number(document.getElementById("modalPesoTotal").value) || null;
  p.cantidad_disponible = Number(document.getElementById("modalCantidadDisponible").value) || null;
  p.peso_disponible = Number(document.getElementById("modalPesoDisponible").value) || null;
  p.uso_diario_cantidad = Number(document.getElementById("modalUsoCantidad").value) || null;
  p.uso_diario_peso = Number(document.getElementById("modalUsoPeso").value) || null;
  localStorage.setItem('inventario', JSON.stringify(productos));
  document.getElementById("modal").style.display = "none";
  renderGrid();
}

function descargarJSON() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(productos, null, 2));
  const a = document.createElement("a");
  a.href = dataStr;
  a.download = "inventario_actualizado.json";
  a.click();
}

renderGrid();
</script>
</body>
</html>
